@page "/MeineVorsorge"

@using System.Text.Json
@using Application.Bvg
@using BlazorBvgRevisionApp.MyComponents.Models
@using Domain.Enums
@using Domain.Models.Bvg
@using Microsoft.AspNetCore.Components.WebAssembly.Hosting

@inject IWebAssemblyHostEnvironment EnvironmentService
@inject BvgRevisionCalculator BvgRevisionCalculator
@inject BvgCalculator BvgCalculator
@inject IPensionSupplementCalculator BvgPensionSupplementCalculator
@inject ILogger<MyPension> Logger

<PageTitle>Meine Vorsorge</PageTitle>

<MudPaper Class="mb-4 pa-6 align-center" Elevation="0">
    <MudText Class="mb-4" Typo="Typo.h4">Nur BVG vergleichen</MudText>
    
    <MudText Class="mb-4" Typo="Typo.h6">Schritt 1: notwendige persönliche Angaben</MudText>

    <MudText Class="mb-4">
        Die Höhe Deines angesparten Guthabens und der daraus resultierenden Rente wird durch verschiedene Faktoren bestimmt.
        Zum Vergleich mit der BVG Reform 21 ist es zudem notwendig, das reglementarische Altersguthaben zum Rentenbeginn zu berücksichtigen,
        denn davon hängt die Höhe des Rentenzuschlags ab.
    </MudText>

    <MudText Class="mb-4">
        Alle diese Werte sind auf Ihrem Vorsorgeausweis, den Sie mindestens einmal jährlich erhalten, aufgeführt.
    </MudText>

    <BvgPersonForm Person="@Person"></BvgPersonForm>
    
    <MudText Class="mt-8" Typo="Typo.h6">Schritt 2: Haben Sie Anspruch auf einen Rentenzuschlag?</MudText>

    <MudText Class="mt-4">
        Falls Sie die beiden Vorraussetzungen für einen Rentenzuschlag erfüllen und Sie einer Übergangsgeneration angehören,
        erhöht sich BVG Altersrente. Details dazu finden Sie <MudLink Target="_blank" Href="https://www.bsv.admin.ch/bsv/de/home/sozialversicherungen/bv/reformen-und-revisionen.html">hier</MudLink>.
    </MudText>

    <EligibleForPension PreCondition="@PreCondition"/>

    <MudGrid>
        <MudItem md="12">
            <MudButton OnClick="OnBvgCalculate" Variant="Variant.Filled" Color="Color.Primary" Disabled="@IsPersonNotValid()">Berechne</MudButton>
        </MudItem>
    </MudGrid>
</MudPaper>

@if(RevisionCalculationResult is not null)
{
    <MudPaper Class="mb-4 pa-6 align-center" Elevation="0">
        <MudText Class="mb-4" Typo="Typo.h5">BVG Berechnungsergebnis</MudText>
        <MudText Typo="Typo.body2">Das Ergebnis der Berechnung zeigt Ihre voraussichtlichen BVG-Altersleistungen. Die Leistungen sind auf Ihren ordentlichen Rentenbeginn gerechnet.</MudText>

        <MudText Typo="Typo.body1" Class="mt-4">Ihr Pensionierungsdatum: @RevisionCalculationResult.DateOfRetirement.ToString("d. MMMM, yyyy")</MudText>

        <RetirementBenefitTable Benefits="@ResultItems()"/>
    </MudPaper>
}

@code
{
    private BvgPersonViewModel Person { get; set; } = new ();
    private BvgCalculationResult? RevisionCalculationResult { get; set; }
    private BvgCalculationResult? CurrentCalculationResult { get; set; }
    private EligibleForPensionViewModel PreCondition { get; } = new();

    protected override void OnInitialized()
    {
        if (EnvironmentService.IsDevelopment())
        {
            Person = GetTestPerson();
        }
    }

    private void OnBvgCalculate(MouseEventArgs obj)
    {
        int calculationYear = DateTime.Now.Year;
        BvgPerson bvgPerson = new()
        {
            ReportedSalary = Person.ReportedSalary,
            Gender = Person.Gender,
            DateOfBirth = Person.DateOfBirth ?? DateTime.MinValue,
            PartTimeDegree = 1
        };

        BvgRevisionCalculator.Calculate(calculationYear, Person.BvgRetirementCapitalEndOfYear, bvgPerson)
        .Match(
            Right: revisionResult =>
            {
                RevisionCalculationResult = revisionResult;
                Logger.LogInformation($"Calculation Result: {JsonSerializer.Serialize(revisionResult)}");
            },
            Left: error =>
            {
                Logger.LogWarning($"Fehler: {error}");
                RevisionCalculationResult = null;
            });

        BvgCalculator.Calculate(calculationYear, Person.BvgRetirementCapitalEndOfYear, bvgPerson)
            .Match(
                Right: result =>
                {
                    CurrentCalculationResult = result;
                    Logger.LogInformation($"Calculation Result: {JsonSerializer.Serialize(result)}");
                },
                Left: error =>
                {
                    Logger.LogWarning($"Fehler: {error}");
                    CurrentCalculationResult = null;
                });

        if (RevisionCalculationResult is not null && PreCondition.IsEligible())
        {
            decimal finalRetirementCapital = Math.Max(Person.FinalRetirementCapital, RevisionCalculationResult.FinalRetirementCapital);

            decimal pensionSupplement = BvgPensionSupplementCalculator.CalculatePensionSupplement(Person.DateOfBirth ?? DateTime.MaxValue, finalRetirementCapital);

            RevisionCalculationResult.RetirementPension += pensionSupplement;
        }
    }

    private TableResult[] ResultItems()
    {
        return
        [
            new TableResult("Altersguthaben", Math.Round(CurrentCalculationResult?.FinalRetirementCapital ?? decimal.Zero), Math.Round(RevisionCalculationResult?.FinalRetirementCapital ?? decimal.Zero)),
            new TableResult("Altersrente", Math.Round(CurrentCalculationResult?.RetirementPension ?? decimal.Zero), Math.Round(RevisionCalculationResult?.RetirementPension ?? decimal.Zero)),
        ];
    }
    

    private bool IsPersonNotValid()
    {
        return !(Person.Gender is not Gender.Undefined &&
               Person.DateOfBirth is not null);
    }

    private BvgPersonViewModel GetTestPerson()
    {
        return new BvgPersonViewModel
            {
                Name = "Toni Vorsorger",
                DateOfBirth = new DateTime(1969, 3, 17),
                ReportedSalary = 100_000,
                BvgRetirementCapitalEndOfYear = 11245,
                FinalRetirementCapital = 250_000,
                Gender = Gender.Male,
            };
    }
}
