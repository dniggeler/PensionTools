@using System.Globalization
@using BlazorBvgRevisionApp.MyComponents.Models
@using Domain.Enums

<MudGrid>
    <MudItem md="4" xs="12">
        <MudNumericField T="int" Label="Ausstellungsjahr" Min="2023" Step="1" @bind-Value="@Person.ValidityYearCertificate"
                         HelperText="Gültigkeit der Werte auf dem Vorsorgeausweis"
                         HelperTextOnFocus="true"
                         Placeholder="Gültigkeitsjahr"/>
    </MudItem>

    <MudItem md="4" xs="12">
        <MudDatePicker @ref="birthdatePicker" Label="Geburtsdatum" Editable="true" DateChanged="@(d => Person.DateOfBirth = d)" DateFormat="yyyy-MM-dd" Required="true" RequiredError="" Placeholder="z.B.1981-02-28" Mask="@(new DateMask("0000-00-00"))" />
    </MudItem>

    <MudItem md="4" xs="12">
        <GenderSelector Label="Geschlecht" SelectedGender="@gender" OnSelected="@(SetGender)" />
    </MudItem>

    <MudItem md="4">
        <MudNumericField Label="AHV-Jahreslohn" Format="n0" Min="0" Step="1000" @bind-Value="Person.ReportedSalary" Culture="CultureInfo.InvariantCulture"/>
    </MudItem>

    <MudItem md="4">
        <MudNumericField Label="Kapital Ende Jahr" Format="n0" Min="0" Step="1000" @bind-Value="Person.BvgRetirementCapitalEndOfYear"
                         HelperTextOnFocus="true"
                         HelperText="Gesamtes Altersguthaben gemäss BVG"
                         Culture="CultureInfo.InvariantCulture" />
    </MudItem>

</MudGrid>

@code {
    private Gender? gender;
    private MudDatePicker? birthdatePicker;

    [Parameter] public required BvgPersonViewModel Person { get; set; }

    [Parameter] public EventCallback<DateTime?> OnBirthDateChanged { get; set; }

    protected override void OnParametersSet()
    {
        if (Person.Gender != Gender.Undefined)
        {
            gender = Person.Gender;
        }

        if(birthdatePicker is not null)
        {
            birthdatePicker.Date = Person.DateOfBirth;
        }
    }

    private void SetGender(Gender? g)
    {
        gender = g;
        if (g.HasValue)
        {
            Person.Gender = g.Value;
        }
    }

    private async Task BirthdateChange(ChangeEventArgs args)
    {
        await OnBirthDateChanged.InvokeAsync();
    }
}