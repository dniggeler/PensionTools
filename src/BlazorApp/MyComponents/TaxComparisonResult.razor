@using Microsoft.AspNetCore.Components
@using PensionCoach.Tools.CommonTypes
@using BlazorApp.MyComponents.TaxComparer
@using Application.Features.TaxComparison.Models

<MudGrid>
    <MudItem md="4" xs="12">
        @if (SelectedPerson is not null)
        {
            <MunicipalityTaxDetailResult
                Title="Meine Wohngemeinde"
                MunicipalityName="@SelectedPerson.MunicipalityName"
                Canton="@SelectedPerson.Canton"
                TotalTaxAmount="@(GetMyMunicipalityTaxAmount())"/>
        }
    </MudItem>

    <MudItem md="4" xs="12">
        @if(minimalTaxResult is not null)
        {
            <MunicipalityTaxDetailResult
                Title="Gemeinde mit tiefster Steuerbelastung"
                MunicipalityName="@minimalTaxResult.MunicipalityName"
                Canton="@minimalTaxResult.Canton"
                TotalTaxAmount="@minimalTaxResult.TotalTaxAmount"/>
        }
    </MudItem>
    
    <MudItem md="4" xs="12">
        @if (maximalTaxResult is not null)
        {
            <MunicipalityTaxDetailResult
                Title="Gemeinde mit tiefster Steuerbelastung"
                MunicipalityName="@maximalTaxResult.MunicipalityName"
                Canton="@maximalTaxResult.Canton"
                TotalTaxAmount="@maximalTaxResult.TotalTaxAmount"/>
        }
    </MudItem>
</MudGrid>

<MudDataGrid @ref="taxResultGrid" Items="TaxCompareResultModels" T="TaxComparerResultReportModel" Striped="true" Virtualize="true" Height="350px">
    <Columns>
        <PropertyColumn Property="r => r.MunicipalityName" Title="Name" />
        <PropertyColumn Property="r => r.Canton" Title="Kanton"/>
        <PropertyColumn Property="r => r.TotalTaxAmount" Title="Total" Format="F0"/>
        <PropertyColumn Property="r => r.MunicipalityTaxAmount" Title="Gemeindesteuer" Format="F0" />
        <PropertyColumn Property="r => r.CantonTaxAmount" Title="Staatssteuer" Format="F0" />
        <PropertyColumn Property="r => r.FederalTaxAmount" Title="Bundessteuer" Format="F0" />
        <PropertyColumn Property="r => r.ChurchTaxAmount" Title="Kirchensteuer" Format="F0" />
    </Columns>
</MudDataGrid>

@code
{
    private TaxComparerResultReportModel minimalTaxResult;
    private TaxComparerResultReportModel maximalTaxResult;

    private MudDataGrid<TaxComparerResultReportModel> taxResultGrid;

    [Parameter]
    public List<TaxComparerResultReportModel> TaxCompareResultModels { get; set; }

    [Parameter]
    public PersonViewModel SelectedPerson { get; set; }

    public void Reload()
    {
        minimalTaxResult = GetMinimumModel();
        maximalTaxResult = GetMaximumModel();
    }

    private decimal? GetMyMunicipalityTaxAmount()
    {
        return TaxCompareResultModels.SingleOrDefault(item => item.MunicipalityId == SelectedPerson.BfsMunicipalityId)?.TotalTaxAmount;
    }

    private TaxComparerResultReportModel GetMinimumModel()
    {
        if (TaxCompareResultModels is null || TaxCompareResultModels.Count == 0)
        {
            return null;
        }

        (decimal _, int index) = TaxCompareResultModels.Select((item, i) => (item.TotalTaxAmount, i)).Min();

        return TaxCompareResultModels[index];
    }

    private TaxComparerResultReportModel GetMaximumModel()
    {
        if (TaxCompareResultModels is null || TaxCompareResultModels.Count == 0)
        {
            return null;
        }

        (decimal _, int index) = TaxCompareResultModels.Select((item, i) => (item.TotalTaxAmount, i)).Max();

        return TaxCompareResultModels[index];
    }
}
